<!DOCTYPE html>

<html>
<head>
  <title>couchapi.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>couchapi.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2 id="a-simple-vows-based-wrapper-for-jquery-couch-js-">A simple vows based wrapper for jquery.couch.js.</h2>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>It is mirroring almost all functionality of the jquery javascript adapter that
comes with futon, but the functions are returning vows instead of expecting
success and error callbacks passed in.</p>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>I added a few more utility functions mainly to easily configure and modify
security objects and design documents.</p>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Make this file useful when included as a simple script tag as well</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> (!window.define) {
    window.define = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> {</span>
        window.couchapi = obj.factory();
    };
}

define(
    { inject: [], 
      factory: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> 
      {</span> <span class="hljs-string">"use strict"</span>;
        <span class="hljs-keyword">var</span> api = {};
        <span class="hljs-keyword">var</span> defaultDesignDocName = <span class="hljs-string">'auth'</span>;
        
        api.withCredentials = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(withCred)</span> {</span>
            console.log(<span class="hljs-string">'in couchapi'</span>);
            $.couch.withCredentials(withCred); 
        };
        
        api.init = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(url, aDefaultDesignDocName)</span> {</span>
            $.couch.urlPrefix = url;
            defaultDesignDocName = aDefaultDesignDocName || defaultDesignDocName;
        };
        
        
        api.config = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(section, option, value)</span>{</span>
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.config({
                success: vow.keep,
                error: vow.break
            },section, option, value);
            <span class="hljs-keyword">return</span> vow.promise;
        };

        api.info = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.info({
                success: vow.keep,
                error: vow.break
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        api.log = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(bytes, offset)</span> {</span>
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.log({</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>never gonna happen.. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                success: vow.keep,</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>jquery.couch.js tries to parse the result, but it is not a json</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                error: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(status, req)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>luckily we can check the status and still return the responseText</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">if</span> (status === <span class="hljs-number">200</span>) vow.keep(req.responseText);
                    <span class="hljs-keyword">else</span> vow.break(status);
                }
                ,bytes:bytes || <span class="hljs-number">1000</span> , offset:offset || <span class="hljs-number">0</span>
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h2 id="sessions">Sessions</h2>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        api.login = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, pwd)</span> {</span>
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.login({
                name: name,
                password: pwd,
                withCredentials:<span class="hljs-literal">true</span>,
                success: vow.keep,
                error: vow.break
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        api.logout = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.logout({
                success: vow.keep,
                error: vow.break
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        api.session = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.session({
                success: vow.keep,
                error: vow.break
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h2 id="databases">Databases</h2>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        api.dbAll = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.allDbs({
                success: vow.keep,
                error: vow.break
            });
            
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        <span class="hljs-keyword">var</span> dbName;
        api.dbSet = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> {</span>
            dbName = name;
        };
        
        api.dbRemove = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> {</span>
            <span class="hljs-keyword">if</span> (name) dbName = name;
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.db(dbName).drop({
                success: vow.keep,
                error: vow.break
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        api.dbCreate = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> {</span>
            <span class="hljs-keyword">if</span> (name) dbName = name;
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.db(dbName).create({
                success: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
                    console.log(<span class="hljs-string">'keeping promise, created database '</span> + name);
                    vow.keep(data);  
                },
                error: vow.break
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        
        api.dbCompact = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> {</span>
            <span class="hljs-keyword">if</span> (name) dbName = name;
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.db(dbName).compact({
                success: vow.keep,
                error: vow.break
            });
            
            <span class="hljs-keyword">return</span> vow.promise;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>call returned object.stop to finish receiving changes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        api.dbChanges = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb, aDbName, options)</span> {</span>
            <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
            <span class="hljs-keyword">var</span> changes = $.couch.db(dbName).changes(<span class="hljs-literal">null</span>, options);
            changes.onChange(
                cb 
            );
            <span class="hljs-keyword">return</span> changes;
        };
        
        api.dbInfo = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> {</span>
            <span class="hljs-keyword">if</span> (name) dbName = name;
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.db(dbName).info({
                success: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
                    data.uri = $.couch.db(dbName).uri;
                    vow.keep(data);
                },
                error: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(status, reason)</span> {</span>
                    <span class="hljs-keyword">var</span> data = { status: status };
                    
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> reason === <span class="hljs-string">'string'</span>)
                        data.reason = reason;
                    <span class="hljs-keyword">else</span> data.reason = reason.responseText;
                        
                    vow.break(data);   
                }
            });
            
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        api.dbSecurity = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(securityObj, aDbName)</span> {</span>
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> securityObj === <span class="hljs-string">'object'</span>) {
                <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
                $.couch.db(dbName).setDbProperty(<span class="hljs-string">'_security'</span>, securityObj, {
                    success: vow.keep,
                    error: vow.break
                });
                
            }
            <span class="hljs-keyword">else</span>  {
                aDbName = securityObj;
                <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
                $.couch.db(dbName).getDbProperty(<span class="hljs-string">'_security'</span>, {
                    success: vow.keep,
                    error: vow.break
                });
                
            }
            <span class="hljs-keyword">return</span> vow.promise;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>set group to create object to hold funName
set funStr to null to delete it the key and value
set funStr to ? to get the content of funName</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        api.dbDesign = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(docName, group, funName, funStr, aDbName)</span> {</span>
            <span class="hljs-keyword">var</span> vow = VOW.make();
            <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">save</span><span class="hljs-params">(designDoc)</span> {</span>
                <span class="hljs-keyword">if</span> (group) {
                    designDoc[group] = designDoc[group] || {};
                    <span class="hljs-keyword">if</span>(funStr) designDoc[group][funName] = funStr;
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">delete</span> designDoc[group][funName];
                }
                <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">if</span> (funStr) designDoc[funName] = funStr;   
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">delete</span> designDoc[funName];
                }
                api.docSave(designDoc).when(
                    vow.keep,
                    vow.break
                );
            }
            api.docGet(<span class="hljs-string">'_design/'</span> + docName).when(
                <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(designDoc)</span> {</span>
                    <span class="hljs-keyword">if</span> (funStr === <span class="hljs-string">"?"</span>)
                        vow.keep(designDoc[group] ? designDoc[group][funName] : designDoc[funName]);
                    <span class="hljs-keyword">else</span> save(designDoc);
                },
                <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">if</span> (funStr === <span class="hljs-string">'?'</span>) vow[<span class="hljs-string">'break'</span>](funName  + <span class="hljs-string">"doesn't exist"</span>);
                    <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">var</span> designDoc = {
                            _id : <span class="hljs-string">'_design/'</span> + docName
                        };
                        save(designDoc);
                    }
                }
            );
            <span class="hljs-keyword">return</span> vow.promise;
            
        };
        
        
        api.dbDesignDoc = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(group, funName, funStr, aDbName)</span> {</span>
            <span class="hljs-keyword">return</span> api.dbDesign(defaultDesignDocName, group, funName, funStr, aDbName);
        };
        
        api.dbFilter = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(filterName, funStr, aDbName)</span> {</span>
            <span class="hljs-keyword">return</span> api.dbDesignDoc(<span class="hljs-string">'filters'</span>, filterName, funStr, aDbName);
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>—————————————-docs
options is optional and can contain key value query params
for instance: open_revs=all rev=asdfasf4333 conflicts=true</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        api.docGet = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(id, options, aDbName)</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options !== <span class="hljs-string">'object'</span>) {
                aDbName = options;   
                options = <span class="hljs-literal">undefined</span>;
            }
            <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            options = $.extend({
                success: vow.keep
                ,error: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(status)</span> {</span>
                    vow[<span class="hljs-string">'break'</span>]({ id: id, options: options, status: status});
                }
            },options);
            $.couch.db(dbName).openDoc(id, options);
            <span class="hljs-keyword">return</span> vow.promise;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Implemention of <a href="http://wiki.apache.org/couchdb/Replication_and_conflicts">http://wiki.apache.org/couchdb/Replication_and_conflicts</a></p>
<ol>
<li>GET docid?conflicts=true</li>
<li>For each member in the _conflicts array:
  GET docid?rev=xxx
If any errors occur at this stage, restart from step 1.
(There could be a race where someone else has already resolved this
conflict and deleted that rev)</li>
<li>Perform application-specific merging</li>
<li>Write _bulk_docs with an update to the first rev and deletes of
the other revs.</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>        api.docConflicts = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(id, aDbName)</span> {</span>
            <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
            <span class="hljs-keyword">var</span> result = [];
            <span class="hljs-keyword">var</span> vow = VOW.make();
            <span class="hljs-keyword">var</span> retries = <span class="hljs-number">0</span>;
            
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRevsVow</span><span class="hljs-params">(revs)</span> {</span>
                <span class="hljs-keyword">var</span> revGetters = [];
                revs.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(rev)</span> {</span>
                    revGetters.push(api.docGet(id, { rev: rev}));
                });
                <span class="hljs-keyword">return</span> VOW.every(revGetters);
            }
            
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRevs</span><span class="hljs-params">(revs)</span> {</span>
                getRevsVow(revs).when(
                    <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
                        vow.keep(result.concat(data));
                    },
                    <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
                        <span class="hljs-keyword">if</span> (retries++ <span class="xml"><span class="hljs-tag">&lt; <span class="hljs-attribute">5</span>) <span class="hljs-attribute">getRevs</span>(<span class="hljs-attribute">revs</span>);
                        <span class="hljs-attribute">else</span> <span class="hljs-attribute">vow</span>['<span class="hljs-attribute">break</span>']({ <span class="hljs-attribute">error:</span> "<span class="hljs-attribute">Couldn</span>'<span class="hljs-attribute">t</span> <span class="hljs-attribute">find</span> <span class="hljs-attribute">at</span> <span class="hljs-attribute">least</span> <span class="hljs-attribute">one</span> <span class="hljs-attribute">of</span> <span class="hljs-attribute">the</span> <span class="hljs-attribute">conflicting</span> <span class="hljs-attribute">revs</span> <span class="hljs-attribute">of</span> <span class="hljs-attribute">doc</span> <span class="hljs-attribute">with</span> <span class="hljs-attribute">id</span> " + <span class="hljs-attribute">id</span>,
                                            <span class="hljs-attribute">data:data</span> });
                    }
                );
            }
            
            <span class="hljs-attribute">function</span> <span class="hljs-attribute">getRevIds</span>(<span class="hljs-attribute">id</span>) {
                <span class="hljs-attribute">api.docGet</span>(<span class="hljs-attribute">id</span>, { <span class="hljs-attribute">conflicts:</span> <span class="hljs-attribute">true</span> })<span class="hljs-attribute">.when</span>(
                    <span class="hljs-attribute">function</span>(<span class="hljs-attribute">doc</span>) {
                        <span class="hljs-attribute">var</span> <span class="hljs-attribute">revs</span> = <span class="hljs-attribute">doc._conflicts</span>;
                        <span class="hljs-attribute">delete</span> <span class="hljs-attribute">doc._conflicts</span>;
                        <span class="hljs-attribute">result.push</span>(<span class="hljs-attribute">doc</span>);
                        <span class="hljs-attribute">if</span> (<span class="hljs-attribute">revs</span>) <span class="hljs-attribute">getRevs</span>(<span class="hljs-attribute">revs</span>); 
                        <span class="hljs-attribute">else</span> <span class="hljs-attribute">vow.keep</span>(<span class="hljs-attribute">result</span>);
                    },
                    <span class="hljs-attribute">function</span>(<span class="hljs-attribute">data</span>) {
</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>couldn’t find the doc, give up</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        vow[<span class="hljs-string">'break'</span>]({ error: <span class="hljs-string">"Couldn't find doc with id "</span> + id, data:data });
                    });
            }
            
            getRevIds(id);
            <span class="hljs-keyword">return</span> vow.promise;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>pass in a doc or id you suspect has conflicts.
resolver is called to decide between conflicting revs
if resolver is left out, a promise is returned with the revs to
choose from, and a continuing function (choose)  to call when you’ve decided
which is the winning rev, pass in its index. Again a promise
is returned of good things achieved..</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        api.docResolveConflicts = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc, resolver, aDbName)</span> {</span>
            <span class="hljs-keyword">var</span> vow = VOW.make();
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> resolver !== <span class="hljs-string">'function'</span>) aDbName = resolver;
            <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
            <span class="hljs-keyword">var</span> id = doc.id ? doc.id : doc;
            
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">prepRevs</span><span class="hljs-params">(revs, winningRev)</span> {</span>
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;revs.length; i++) {
                    <span class="hljs-keyword">if</span> (i !== winningRev) {
                        <span class="hljs-keyword">var</span> r = revs[i];
                        revs[i] = { _id: r._id, _rev: r._rev,  _deleted : <span class="hljs-literal">true</span> };
                    }
                }
            }
            
            api.docConflicts(id).when(
                <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(revs)</span> {</span>
                    <span class="hljs-keyword">if</span> (revs.length === <span class="hljs-number">1</span>) {
                        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> resolver === <span class="hljs-string">'function'</span>)
                            vow.keep(revs[<span class="hljs-number">0</span>]);   
                        <span class="hljs-keyword">else</span> {
                            vow.keep({
                                revs: revs,
                                fun: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span> <span class="hljs-keyword">return</span> VOW.kept(); }
                            });
                        }
                    }
                    <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> resolver === <span class="hljs-string">'function'</span>) {
                            prepRevs(revs, resolver(revs));
                            api.docBulkSave(revs).when(
                                <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span> vow.keep(data); },
                                <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span> vow[<span class="hljs-string">'break'</span>](data); }
                            );
                        }
                        <span class="hljs-keyword">else</span> vow.keep(
                            { revs: revs,
                              choose: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(winningRev)</span> {</span>
                                  prepRevs(revs, winningRev);
                                  <span class="hljs-keyword">return</span> api.docBulkSave(revs);
                              }
                            }
                        );
                    }
                }, 
                <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span> vow[<span class="hljs-string">'break'</span>](data); }
            );
            <span class="hljs-keyword">return</span> vow.promise;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        
        api.docRemove = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc, aDbName)</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> doc === <span class="hljs-string">'string'</span>)
                <span class="hljs-keyword">return</span> api.docRemoveById(doc, aDbName);
            <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.db(dbName).removeDoc(doc, {
                success: vow.keep,
                error: vow.break
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        api.docRemoveById = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(id, aDbName)</span> {</span>
            <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
            <span class="hljs-keyword">var</span> vow = VOW.make();
            api.docGet(id).when(
                <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> {</span>
                    api.docRemove(doc).when(
                        vow.keep,
                        vow.break
                    );
                },
                vow.keep
            );
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        api.docBulkRemove = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(docs, aDbName)</span> {</span>
            <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.db(dbName).bulkRemove({<span class="hljs-string">"docs"</span>: docs }, {
                success: vow.keep,
                error: vow.break
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        api.docBulkSave = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(docs, aDbName)</span> {</span>
            <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.db(dbName).bulkSave({<span class="hljs-string">"docs"</span>: docs }, {
                success: vow.keep,
                error: vow.break
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        api.docAllInclude= <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(aDbName)</span> {</span>
            <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.db(dbName).allDocs({
                <span class="hljs-string">"include_docs"</span>: <span class="hljs-literal">true</span>,
                success: vow.keep,
                error: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(status, reason)</span> {</span>
                    vow.break(reason);
                }
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        
        api.docAll= <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(aDbName)</span> {</span>
            <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.db(dbName).allDocs({
                success: vow.keep,
                
                error: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(status, reason)</span> {</span>
                    vow.break(reason); }
                
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        api.docAllDesignInclude = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(aDbName)</span> {</span>
            <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.db(dbName).allDesignDocs({
                <span class="hljs-string">"include_docs"</span>: <span class="hljs-literal">true</span>,
                success: vow.keep,
                error: vow.break
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        
        api.docAllDesign= <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(aDbName)</span> {</span>
            <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.db(dbName).allDesignDocs({
                success: vow.keep,
                error: vow.break
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>not working under cors at least: XMLHttpRequest cannot load
<a href="http://localhost:5984/b/asdfasf">http://localhost:5984/b/asdfasf</a>. Method COPY is not allowed
by Access-Control-Allow-Methods.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        api.docCopy = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(id, newId, aDbName)</span> {</span>
            <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.db(dbName).copyDoc(id, {
                success: vow.keep,
                error: vow.break
            }, {
                beforeSend: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> {</span>
                    xhr.setRequestHeader(<span class="hljs-string">"Destination"</span>, newId);
                }
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        api.docSave = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc, aDbName)</span> {</span>
            <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.db(dbName).saveDoc(doc, {
                success: vow.keep,
                error: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(status, error, reason)</span> {</span>
                    <span class="hljs-keyword">var</span> data = { status: status };
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> reason === <span class="hljs-string">'string'</span>)
                        data.reason = reason;
                    <span class="hljs-keyword">else</span> data.reason = error;
                        
                    vow.break(data);   
                }
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>————————-misc </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        api.list = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(designDoc, listName, aDbName)</span> {</span>
            <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.db(dbName).list(designDoc + <span class="hljs-string">'/'</span> + listName,<span class="hljs-string">'all'</span>, {
                success: vow.keep,
                error: vow.break,
                reduce: <span class="hljs-literal">false</span>
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        api.viewCompact = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(aDbName)</span> {</span>
            <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
            <span class="hljs-keyword">var</span> vow = vow.make(); 
            $.couch.db(dbName).compactView({
                success: vow.keep,
                error: vow.break
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        api.viewCleanup = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(aDbName)</span> {</span>
            <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
            <span class="hljs-keyword">var</span> vow = vow.make(); 
            $.couch.db(dbName).viewCleanup({
                success: vow.keep,
                error: vow.break
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        api.view = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(designDoc, viewName, aDbName)</span> {</span>
            <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.db(dbName).view(designDoc + <span class="hljs-string">'/'</span> + viewName , {
                success: vow.keep,
                error: vow.break,
                reduce: <span class="hljs-literal">false</span>
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        api.viewTemp = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(map, aDbName)</span> {</span>
            <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.db(dbName).query(map,<span class="hljs-string">"_count"</span>, <span class="hljs-string">"javascript"</span>, {
                success: vow.keep,
                error: vow.break,
                reduce: <span class="hljs-literal">false</span>
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        api.activeTasks = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.activeTasks({
                success: vow.keep,
                error: vow.break
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        <span class="hljs-keyword">var</span> conflictsMap = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> {</span>
            <span class="hljs-keyword">if</span> (doc._conflicts) {
                emit(<span class="hljs-literal">null</span>, [doc._rev].concat(doc._conflicts));
            }
        };
        
        <span class="hljs-keyword">var</span> conflictsView = {<span class="hljs-string">"map"</span> : conflictsMap.toString()};
        
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkForConflictsView</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> vow = VOW.make();
            api.dbDesign(<span class="hljs-string">'couchapi'</span>, <span class="hljs-string">'views'</span>, <span class="hljs-string">'conflicts'</span>, <span class="hljs-string">"?"</span>).
                when(
                    vow.keep
                    ,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                        api.dbDesign(<span class="hljs-string">'couchapi'</span>, <span class="hljs-string">'views'</span>, <span class="hljs-string">'conflicts'</span>, conflictsView).
                            when(
                                vow.keep,
                                vow.break
                            );
                    }
                );
            <span class="hljs-keyword">return</span> vow.promise;
        }
        
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRevs</span><span class="hljs-params">(ids)</span> {</span>
            <span class="hljs-keyword">var</span> vow = VOW.make();
            <span class="hljs-keyword">var</span> getters = {};
                <span class="hljs-keyword">var</span> idVows = [];
                <span class="hljs-built_in">Object</span>.keys(ids).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(id)</span> {</span>
                    getters[id] = [];
                    <span class="hljs-keyword">var</span> revs = ids[id]; 
                    revs.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(rev)</span> {</span>
                        getters[id].push(api.docGet(id, { <span class="hljs-string">'rev'</span>: rev}));
                    });
                    idVows.push(VOW.every(getters[id]));
                });
            <span class="hljs-keyword">if</span> (idVows.length === <span class="hljs-number">0</span>) vow.keep([]);
            <span class="hljs-keyword">else</span> VOW.every(idVows).when(
                <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
                        <span class="hljs-keyword">var</span> conflicts = {};
                    data.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> {</span>
                        conflicts[doc[<span class="hljs-number">0</span>]._id] = doc;
                    });
                    
                    vow.keep(conflicts);
                },
                vow.break
            );
            <span class="hljs-keyword">return</span> vow.promise;
        }
        
        api.dbConflicts = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fetchDocs, aDbName)</span> {</span>
            <span class="hljs-keyword">var</span> vow = VOW.make();
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fetchDocs !== <span class="hljs-string">'boolean'</span>) {
                aDbName = fetchDocs;   
                fetchDocs = <span class="hljs-literal">false</span>;
            }
            <span class="hljs-keyword">if</span> (aDbName) dbName = aDbName;
            checkForConflictsView().when(
                <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">return</span> api.view(<span class="hljs-string">'couchapi'</span>, <span class="hljs-string">'conflicts'</span>);
                }
            ).when(
                <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
                    console.log(data);
                        <span class="hljs-keyword">var</span> idsWithConflicts = {};
                    data.rows.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(r)</span>{</span>
                        idsWithConflicts[r.id] = r.value; 
                    });
                    <span class="hljs-keyword">if</span> (!fetchDocs) <span class="hljs-keyword">return</span> VOW.kept(idsWithConflicts);
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> getRevs(idsWithConflicts);
                }).when(
                    vow.keep,
                    vow.break
                );
            <span class="hljs-keyword">return</span> vow.promise;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>not tested yet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        api.replicateStop = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(repId)</span> {</span>
            <span class="hljs-keyword">var</span> repOptions = repOptions || {};
            repOptions.cancel = <span class="hljs-literal">true</span>;
            repOptions.replication_id = repId;
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.replicate(<span class="hljs-string">''</span>, <span class="hljs-string">''</span>, {
                success: vow.keep,
                error: vow.break
            }, repOptions);
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        api.replicateDo = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(db1, db2, repOptions)</span> {</span>
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.replicate(db1, db2, {
                success: vow.keep,
                error: vow.break
            }, repOptions);
            <span class="hljs-keyword">return</span> vow.promise;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>“source”, “target”, “create_target”, “continuous”, “doc_ids”, “filter”, “query_params”, “user_ctx”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        api.replicationAdd = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(id, repDoc)</span> {</span>
            repDoc._id = id || api.UUID();
            <span class="hljs-keyword">if</span> (repDoc.role)
                repDoc.user_ctx = { <span class="hljs-string">"roles"</span>: [repDoc.role] };
            <span class="hljs-keyword">if</span> (repDoc.filterName)
                repDoc.filter = defaultDesignDocName + <span class="hljs-string">'/'</span> + repDoc.filterName;
            <span class="hljs-keyword">return</span> api.docSave(repDoc, <span class="hljs-string">'_replicator'</span>);
        };
        
        api.replicationRemove = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(id)</span> {</span>
            <span class="hljs-keyword">return</span> api.docRemove(id, <span class="hljs-string">'_replicator'</span>);
        }; 
        
        
        api.UUID = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> $.couch.newUUID();
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>————————————users</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        api.userAdd = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, pwd, roles)</span> {</span>
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            <span class="hljs-keyword">var</span> userDoc = {
                name: name
                ,roles: roles
            };
            $.couch.signup(userDoc, pwd, {
                success: vow.keep,
                error: vow.break
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        api.userRemove = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> {</span>
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.userDb(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
                <span class="hljs-keyword">var</span> dbName = data.name;
                api.docRemove(name, dbName).when(
                    vow.keep, vow[<span class="hljs-string">'break'</span>]
                );</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>$.couch.db(dbName).removeDoc(name, {
    success: vow.keep,
    error: vow.break
});</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            });
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        api.userGet = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> {</span>
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.userDb(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
                <span class="hljs-keyword">var</span> dbName = data.name;
                $.couch.db(dbName).openDoc(<span class="hljs-string">'org.couchdb.user:'</span> +name, {
                    success: vow.keep,
                    error: vow.break
                });
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        
        api.userUpdate = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, props)</span> {</span>
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.userDb(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
                <span class="hljs-keyword">var</span> dbName = data.name;
                $.couch.db(dbName).openDoc(<span class="hljs-string">'org.couchdb.user:'</span> + name, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
                        <span class="hljs-built_in">Object</span>.keys(props).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> {</span>
                            data[p] = props[p]; 
                        });
                        $.couch.db(dbName).saveDoc(data, {
                            success: vow.keep,
                            error: vow.break
                        });
                    },
                    error: vow.break
                });
            });
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        api.userRoles = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, roles)</span> {</span>
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            <span class="hljs-keyword">if</span> (roles) {
                api.userUpdate(name, {roles:roles}).when(
                    vow.keep,
                    vow.break
                );
            }
            <span class="hljs-keyword">else</span> api.userGet(name).when(
                vow.keep,
                vow.break
            );
            <span class="hljs-keyword">return</span> vow.promise;
        };
        
        api.userRemoveRole = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, role)</span> {</span>
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.userDb(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
                <span class="hljs-keyword">var</span> dbName = data.name;
                $.couch.db(dbName).openDoc(<span class="hljs-string">'org.couchdb.user:'</span> + name, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
                        <span class="hljs-keyword">if</span> (data.roles.indexOf(role) !== -<span class="hljs-number">1</span>) {
                            data.roles = data.filter(
                                <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span>{</span> <span class="hljs-keyword">return</span> e !==role; });
                            $.couch.db(dbName).saveDoc(data, {
                                success: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
                                    vow.keep(data);
                                },
                                error: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(status)</span> {</span>
                                    vow[<span class="hljs-string">'break'</span>](status);
                                }
                            });
                        }
                        <span class="hljs-keyword">else</span> vow.keep(data);
                        
                    },
                    error: vow.break
                });
            });
            <span class="hljs-keyword">return</span> vow.promise;
        }; 
        
        api.userAddRole = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, role)</span> {</span>
            <span class="hljs-keyword">var</span> vow = VOW.make(); 
            $.couch.userDb(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
                <span class="hljs-keyword">var</span> dbName = data.name;
                $.couch.db(dbName).openDoc(<span class="hljs-string">'org.couchdb.user:'</span> + name, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
                        <span class="hljs-keyword">if</span> (data.roles.indexOf(role) === -<span class="hljs-number">1</span>) {
                            data.roles.push(role);
                            $.couch.db(dbName).saveDoc(data, {
                                success: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
                                    vow.keep(data);
                                },
                                error: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(status)</span> {</span>
                                    vow[<span class="hljs-string">'break'</span>](status);
                                }
                            });
                        }
                        <span class="hljs-keyword">else</span> vow.keep(data);
                        
                    },
                    error: vow.break
                });
            });
            <span class="hljs-keyword">return</span> vow.promise;
        }; 
        
        api.test = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            api[<span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>]].apply(api, <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>)).
                when(
                    <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
                        console.log(<span class="hljs-string">"SUCCESS!!"</span>);
                        console.log(data);
                    },
                    <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
                        console.log(<span class="hljs-string">'FAIL'</span>);
                        console.log(data);
                    }
                );
            <span class="hljs-keyword">return</span> <span class="hljs-string">'Wait for it...'</span>;
        };

        <span class="hljs-keyword">return</span> api;
      }});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
